<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MCP LLM Test</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
        #out { white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; min-height: 160px; }
        .small { color: #666; font-size: 12px; }
        label { margin-right: 6px; }
    </style>
    </head>
<body>
    <h2>MCP LLM-Driven Test</h2>
    <form id="f">
        <label>Session:</label> <input id="session" value="dev" />
        <label>Org:</label> <input id="org" value="default" />
        <br/><br/>
        <label>Question:</label>
        <input id="q" style="width: 80%" value="What wines have alcohol percentage above 12%?" />
        <button type="submit">Generate Query</button>
    </form>
    <p class="small">This uses the new LLM-driven /v1/generate-llm endpoint with intelligent query planning.</p>
    <div id="out"></div>
    <script>
    // Read URL parameters and populate form fields
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('sessionId')) {
        document.getElementById('session').value = urlParams.get('sessionId');
    }
    if (urlParams.get('orgId')) {
        document.getElementById('org').value = urlParams.get('orgId');
    }
    if (urlParams.get('question')) {
        document.getElementById('q').value = decodeURIComponent(urlParams.get('question'));
    }

    const out = document.getElementById('out');
    const form = document.getElementById('f');
    let abortController;
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (abortController) { abortController.abort(); }
        abortController = new AbortController();
        
        out.textContent = '';
        const sessionId = document.getElementById('session').value || 'dev';
        const orgId = document.getElementById('org').value || 'default';
        const userQuestion = document.getElementById('q').value || 'What wines have alcohol percentage above 12%?';
        
        const requestBody = {
            user_question: userQuestion,
            org_id: orgId,
            sessionId: sessionId
        };
        
        out.textContent = `ü§ñ LLM Query Generation Starting...\n`;
        out.textContent += `Question: "${userQuestion}"\n`;
        out.textContent += `Org: ${orgId}, Session: ${sessionId}\n\n`;
        
        try {
            const response = await fetch('/v1/generate-llm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody),
                signal: abortController.signal
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                out.textContent += `‚ùå ERROR: ${response.status} ${response.statusText}\n${errorText}\n`;
                return;
            }
            
            const result = await response.json();
            
            // Display LLM Query Plan
            if (result.metadata?.queryPlan) {
                out.textContent += `üß† LLM QUERY PLAN:\n`;
                out.textContent += `- Query Type: ${result.metadata.queryPlan.queryType}\n`;
                out.textContent += `- Target Object: ${result.metadata.queryPlan.targetObject}\n`;
                out.textContent += `- Confidence: ${result.metadata.queryPlan.confidence}\n`;
                out.textContent += `- Business Context: ${result.metadata.queryPlan.businessContext}\n`;
                out.textContent += `- Reasoning: ${result.metadata.queryPlan.reasoning}\n\n`;
                
                if (result.metadata.queryPlan.soql) {
                    out.textContent += `üîç Generated SOQL:\n${result.metadata.queryPlan.soql}\n\n`;
                }
                if (result.metadata.queryPlan.sosl) {
                    out.textContent += `üîç Generated SOSL:\n${result.metadata.queryPlan.sosl}\n\n`;
                }
            }
            
            // Display Results
            if (result.type === 'text' && result.content) {
                // Handle LLM text responses (like aggregated analysis)
                out.textContent += `üìä ANALYSIS:\n`;
                out.textContent += result.content + '\n';
            } else if (result.content?.rows?.length > 0) {
                // Handle table responses
                out.textContent += `üìä RESULTS (${result.content.rows.length} rows):\n`;
                out.textContent += `Columns: ${result.content.columns.join(', ')}\n\n`;
                
                // Show first few rows
                const maxRows = Math.min(10, result.content.rows.length);
                for (let i = 0; i < maxRows; i++) {
                    const row = result.content.rows[i];
                    out.textContent += `Row ${i + 1}: ${JSON.stringify(row)}\n`;
                }
                
                if (result.content.rows.length > 10) {
                    out.textContent += `... and ${result.content.rows.length - 10} more rows\n`;
                }
            } else {
                out.textContent += `üìä RESULTS: No data returned\n`;
            }
            
            // Display Security Info
            if (result.metadata?.security) {
                out.textContent += `\nüîí SECURITY INFO:\n`;
                if (result.metadata.security.flsRestricted) {
                    out.textContent += `- Field-level security applied\n`;
                }
                if (result.metadata.security.droppedFields?.length > 0) {
                    out.textContent += `- Dropped fields: ${result.metadata.security.droppedFields.join(', ')}\n`;
                }
            }
            
            out.textContent += `\n‚úÖ LLM Query Complete!`;
            
        } catch (error) {
            if (error.name === 'AbortError') {
                out.textContent += `\n‚èπÔ∏è Request cancelled\n`;
            } else {
                out.textContent += `\n‚ùå ERROR: ${error.message}\n`;
                console.error('LLM Query Error:', error);
            }
        }
    });
    </script>
</body>
</html>

